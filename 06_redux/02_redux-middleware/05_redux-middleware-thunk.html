<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redux Thunk API Example</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/redux@4.2.0/dist/redux.js"></script>
    <script src="https://unpkg.com/react-redux@8.0.4/dist/react-redux.js"></script>
    <script src="https://unpkg.com/redux-actions@2.6.5/dist/redux-actions.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">

        /*
            Redux Thunk ë€ ?
            ë¹„ë™ê¸° ë¡œì§, ì¡°ê±´ë¶€ ë¡œì§ ë“±ë“± ì¡°ê±´ì— ë”°ë¼ì„œ action ì„ dispatch
            í•  ì§€ ì—¬ë¶€ë¥¼ ê²°ì •í•  ìˆ˜ ìˆë‹¤.
            Redux ì˜ dispatch ë¥¼ í™•ì¥í•˜ì—¬ ë³´ë‹¤ ì‰½ê²Œ ë¹„ë™ê¸° ì²˜ë¦¬ë¥¼
            ê´€ë¦¬ í•  ìˆ˜ ìˆëŠ” í•˜ë‚˜ì˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ì´ë‹¤.
        */

        const { Provider, useSelector, useDispatch } = ReactRedux;
        const { createStore, applyMiddleware } = Redux;
        const { handleActions } = ReduxActions;

        /* âœ… 1. ì´ˆê¸° ìƒíƒœ (íšŒì› ëª©ë¡) */
        const initialState = [];

        /* âœ… 2. ì•¡ì…˜ ì •ì˜ (ë°ì´í„° ìš”ì²­) */
        const FETCH_DATA = 'FETCH_DATA';

        /* âœ… 3. Redux Thunk ë¯¸ë“¤ì›¨ì–´ */

        /*
            action ì„ ë§¤ê°œë³€ìˆ˜ë¡œ í•˜ëŠ” ì½œë°± í•¨ìˆ˜ë¥¼ asyncë¡œ í•˜ì—¬
            api í˜¸ì¶œ í›„ì— next ì— action ê°ì²´ë¥¼ ë‹¤ì‹œ ìƒì„±í•˜ì—¬ í˜¸ì¶œí•œë‹¤.

            ê²°ë¡ ì€, dispatch ë¥¼ í˜¸ì¶œ í•  ë•Œ action ìƒì„± í•¨ìˆ˜ì˜ ê²°ê³¼ì¸
            action ê°ì²´ë¥¼ ì „ë‹¬í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ async ì½œë°± í•¨ìˆ˜ë¥¼ ì „ë‹¬í•˜ê³ 
            ë¯¸ë“¤ì›¨ì–´ëŠ” í•˜ë‚˜ë§Œ ë§Œë“¤ì–´ë‘ê³  ì½œë°±í•¨ìˆ˜ë§Œ ë³€ê²½ì„ í•˜ë©°
            api í†µì‹ ì„ ì§„í–‰í•˜ê¸° ìœ„í•¨ì´ë‹¤.
        */
        const thunkMiddleware = ({ dispatch, getState }) => next => action => {

            /*
                dispatch ì‹œ í•¨ìˆ˜ê°€ ì „ë‹¬ë˜ë©´ ì „ë‹¬ ëœ ì½œë°± í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ë©°
                dispatch ì™€ getStateë¥¼ ì „ë‹¬
            */

            console.log(action)
            console.log(dispatch)
            console.log(getState)

            if (typeof action === 'function') {
                return action(dispatch, getState);
            }

            // í•¨ìˆ˜ê°€ ì•„ë‹Œ ê²½ìš°ë„¤ëŠ” ì›ë˜ì˜ íë¦„ëŒ€ë¡œ ë‹¤ìŒ ë¯¸ë“¤ì›¨ì–´ or ë¦¬ë“€ì„œ í˜¸ì¶œ
            return next(action);
        };



        /* âœ… 4. ë¹„ë™ê¸° API í˜¸ì¶œ í•¨ìˆ˜ (Thunk Action) */
        const getUser = async (dispatch, getState) => {
            console.log('ğŸ“¢ API ìš”ì²­ ì¤‘...');

            // ğŸ”¥ API ìš”ì²­ (ê°€ì§œ íšŒì› ì •ë³´ ê°€ì ¸ì˜¤ê¸°)
            const response = await fetch('https://jsonplaceholder.typicode.com/users')
                .then(res => res.json());

            console.log('âœ… API ì‘ë‹µ ë°ì´í„°:', response);

            // ğŸ“¢ ë°ì´í„°ë¥¼ Redux Storeì— ì €ì¥
            dispatch({ type: FETCH_DATA, payload: response });
        };

        /* âœ… 5. ë¦¬ë“€ì„œ (state ì—…ë°ì´íŠ¸) */
        const reducer = handleActions(
            {
                [FETCH_DATA]: (state, { payload }) => {
                    console.log('ğŸ”¥ ë¦¬ë“€ì„œ ì‹¤í–‰ë¨! ìƒˆë¡œìš´ ë°ì´í„°:', payload);
                    return payload;  // ë°›ì•„ì˜¨ íšŒì› ëª©ë¡ì„ stateì— ì €ì¥!
                }
            },
            initialState
        );

        /* âœ… 6. UI ì»´í¬ë„ŒíŠ¸ */
        function App() {
            const users = useSelector(state => state);
            const dispatch = useDispatch();

            const onClickHandler = () => {
                dispatch(getUser);  // ğŸš€ Redux Thunkë¡œ ë¹„ë™ê¸° API ìš”ì²­
            };

            return (
                <>
                    <h1>íšŒì› ëª©ë¡</h1>
                    <button onClick={onClickHandler}>ì¡°íšŒí•˜ê¸°</button>
                    <ul>
                        {users.map(user => <li key={user.id}>{user.name}</li>)}
                    </ul>
                </>
            );
        }

        /* âœ… 7. Redux Store ìƒì„± (ë¯¸ë“¤ì›¨ì–´ ì ìš©) */
        const store = createStore(reducer, applyMiddleware(thunkMiddleware));

        /* âœ… 8. React + Redux ì—°ê²° */
        ReactDOM.createRoot(document.getElementById('root')).render(
            <Provider store={store}>
                <App />
            </Provider>
        );
    </script>
</body>
</html>
